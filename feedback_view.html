z<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DMP Feedback Results</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 0; background: #f8f8fa; color: #222; }
        .container { max-width: 900px; margin: 32px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 12px #0001; padding: 32px; }
        h1 { font-size: 2rem; margin-bottom: 0.5em; }
        h2 { margin-top: 2em; color: #3a3a5a; border-bottom: 1px solid #eee; padding-bottom: 0.2em; }
        h3 { margin-top: 1.5em; color: #3a3a5a; }
        .centered { text-align: center; }
        .feedback-note { background: #f4f9ff; border-left: 5px solid #3399cc; padding: 1em; margin-bottom: 2em; white-space: pre-wrap; }
        .domain-summary { margin-bottom: 1.5em; }
        .domain-title { font-weight: bold; font-size: 1.1em; }
        .section-header { background: #f1f5fb; padding: 0.5em; margin: 1em 0; font-weight: bold; }
        .metadata-item { margin-bottom: 0.5em; }
        .assessment-scale { display: flex; justify-content: space-between; margin: 1em 0; }
        .assessment-item { padding: 0.5em 1em; border-radius: 4px; text-align: center; flex: 1; margin: 0 0.5em; }
        .assessment-poor { background: #f8d7da; }
        .assessment-satisfactory { background: #fff3cd; }
        .assessment-excellent { background: #c6f6d5; }
        .assessment-active { border: 2px solid #333; }
        .compliance-badge { display: inline-block; padding: 0.2em 0.8em; border-radius: 16px; font-size: 0.95em; margin-right: 0.7em; }
        .compliance-FullyMet, .compliance-Excellent { background: #c6f6d5; color: #137333; }
        .compliance-PartiallyMet, .compliance-Satisfactory { background: #fff3cd; color: #856404; }
        .compliance-NotMet, .compliance-Poor { background: #f8d7da; color: #a71d2a; }
        .compliance-Unknown { background: #e2e3e5; color: #495057; }
        .results-table { width: 100%; border-collapse: collapse; margin-top: 1em; margin-bottom: 2em; }
        .results-table th, .results-table td { border: 1px solid #e0e0e0; padding: 0.6em 0.5em; text-align: left; vertical-align: top; }
        .results-table th { background: #f1f5fb; }
        .results-table tr:nth-child(even) { background: #fafbfc; }
        .loading, .error { margin: 2em 0; font-size: 1.2em; text-align: center; }
        .overall-score { font-size: 1.2em; margin: 1em 0; }
        .score-value { font-weight: bold; }
    </style>
</head>
<body>
<div class="container">
    <h1 class="centered">AI-powered DMP Assessment</h1>
    <div id="loading" class="loading">Loading analysis...</div>
    <div id="error" class="error" style="display:none;"></div>
    <div id="results" style="display:none;">
        <!-- PDF Export Button -->
        <div class="pdf-export-container" style="text-align: right; margin-bottom: 1em;">
            <button id="export-pdf" class="export-button" style="padding: 8px 16px; background-color: #3399cc; color: white; border: none; border-radius: 4px; cursor: pointer;">
                <span style="margin-right: 5px;">ðŸ“„</span> Download PDF Report
            </button>
        </div>
        <!-- Manuscript Metadata Section -->
        <div id="manuscript-metadata"></div>
        
        <!-- Analysis Information Section -->
        <h2>Analysis Information</h2>
        <div id="analysis-info"></div>
        
        <!-- Overall Assessment Section -->
        <h2>Overall Assessment</h2>
        <div id="overall-assessment"></div>
        
        <!-- Checklist Information Section -->
        <h2>Checklist Information</h2>
        <div id="checklist-info"></div>
        
        <!-- Feedback Note Section -->
        <h2>Feedback Summary</h2>
        <div id="feedback-note" class="feedback-note"></div>
        
        <!-- Domain Summaries Section -->
        <h2>Summary of Results</h2>
        <div id="domain-summaries"></div>
        
        <!-- Detailed Results Section -->
        <h2>Detailed Results</h2>
        <div id="domains"></div>
    </div>
</div>
<script>
// --- Utility Functions --- //
function getTokenFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get('token') || '';
}
function escapeHTML(str) {
    if (!str) return '';
    return str.replace(/[&<>"']/g, function(tag) {
        const chars = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
        return chars[tag] || tag;
    });
}
function complianceClass(compliance) {
    if (!compliance) return 'compliance-Unknown';
    const c = compliance.toLowerCase();
    if (c.includes('full')) return 'compliance-FullyMet';
    if (c.includes('partial')) return 'compliance-PartiallyMet';
    if (c.includes('not')) return 'compliance-NotMet';
    return 'compliance-Unknown';
}

// --- Render Functions --- //
function renderManuscriptMetadata(data) {
    const container = document.getElementById('manuscript-metadata');
    
    // Get DMP metadata from summary or raw_outputs
    const summary = data.summary || {};
    let dmpMetadata = summary.dmp_metadata || {};
    
    // If not in summary, check raw_outputs as fallback
    if (!dmpMetadata || Object.keys(dmpMetadata).length === 0) {
        const rawOutputs = data.raw_outputs || {};
        dmpMetadata = rawOutputs.dmp_metadata || {};
    }
    
    // Get manuscript title from various possible locations
    let manuscriptTitle = '';
    if (dmpMetadata && dmpMetadata.title) {
        manuscriptTitle = dmpMetadata.title;
    } else if (data.title) {
        manuscriptTitle = data.title;
    } else if (data.manuscript_title) {
        manuscriptTitle = data.manuscript_title;
    } else {
        manuscriptTitle = 'Untitled Manuscript';
    }
    
    // Add manuscript title
    const titleElem = document.createElement('h3');
    titleElem.className = 'centered';
    titleElem.textContent = manuscriptTitle;
    container.appendChild(titleElem);
    
    // Add DMP metadata fields
    if (dmpMetadata) {
        // Add study design if available
        if (dmpMetadata.design) {
            const designElem = document.createElement('p');
            designElem.className = 'centered';
            designElem.textContent = `Study Design: ${dmpMetadata.design}`;
            container.appendChild(designElem);
        }
        
        // Add discipline if available
        if (dmpMetadata.discipline) {
            const disciplineElem = document.createElement('p');
            disciplineElem.className = 'centered';
            disciplineElem.textContent = `Discipline: ${dmpMetadata.discipline}`;
            container.appendChild(disciplineElem);
        }
    }
    
    // Add authors if available
    if (data.authors) {
        const authorsElem = document.createElement('p');
        let authorsText = '';
        if (Array.isArray(data.authors)) {
            authorsText = data.authors.join(', ');
        } else {
            authorsText = String(data.authors);
        }
        authorsElem.textContent = `Authors: ${authorsText}`;
        container.appendChild(authorsElem);
    }
    
    // Add DOI if available
    if (data.doi) {
        const doiElem = document.createElement('p');
        let doiText = '';
        if (typeof data.doi === 'object' && data.doi.$oid) {
            doiText = data.doi.$oid;
        } else {
            doiText = String(data.doi);
        }
        doiElem.textContent = `DOI: ${doiText}`;
        container.appendChild(doiElem);
    }
}

function renderAnalysisInfo(data) {
    const container = document.getElementById('analysis-info');
    
    // Check if we have enriched_data structure
    const enrichedData = data.enriched_data || {};
    
    // Add analysis date if available
    const createdAt = data.created_at;
    // Try to get timestamp from different possible locations
    let timestamp = enrichedData.timestamp || data.timestamp;
    
    if (timestamp) {
        // Handle MongoDB date format if present
        if (typeof timestamp === 'object' && timestamp.$date) {
            timestamp = timestamp.$date;
        }
        const formattedDate = new Date(timestamp).toLocaleDateString();
        const dateElem = document.createElement('p');
        dateElem.className = 'metadata-item';
        dateElem.textContent = `Analysis Date: ${formattedDate}`;
        container.appendChild(dateElem);
    } else if (createdAt) {
        // Fallback to created_at
        let dateStr = createdAt;
        if (typeof createdAt === 'object' && createdAt.$date) {
            dateStr = createdAt.$date;
        }
        const formattedDate = new Date(dateStr).toLocaleDateString();
        const dateElem = document.createElement('p');
        dateElem.className = 'metadata-item';
        dateElem.textContent = `Analysis Date: ${formattedDate}`;
        container.appendChild(dateElem);
    }
    
    // Add run ID information
    const runId = enrichedData.run_id || data.run_id;
    if (runId) {
        const runIdElem = document.createElement('p');
        runIdElem.className = 'metadata-item';
        runIdElem.textContent = `Analysis ID: ${runId}`;
        container.appendChild(runIdElem);
    } else if (data._id) {
        // Fallback to _id
        let idStr = data._id;
        if (typeof data._id === 'object' && data._id.$oid) {
            idStr = data._id.$oid;
        }
        const idElem = document.createElement('p');
        idElem.className = 'metadata-item';
        idElem.textContent = `Analysis ID: ${idStr}`;
        container.appendChild(idElem);
    }
    
    // Add configuration information
    const configId = enrichedData.config_id || data.config_id;
    if (configId) {
        const configElem = document.createElement('p');
        configElem.className = 'metadata-item';
        configElem.textContent = `Configuration: ${configId}`;
        container.appendChild(configElem);
    }
}

function renderFeedbackNote(note) {
    document.getElementById('feedback-note').innerHTML = note ? escapeHTML(note).replace(/\n/g, '<br>') : '<em>No feedback note found.</em>';
}
function renderDomainSummaries(data) {
    const container = document.getElementById('domain-summaries');
    container.innerHTML = '';
    
    // Get domains from sections in the new enriched checklist structure
    let domains = [];
    if (data.sections) {
        for (const section of data.sections) {
            if (section.domains) {
                domains = domains.concat(section.domains);
            }
        }
    } else if (data.domains) {
        domains = data.domains;
    }
    
    if (!domains || domains.length === 0) {
        container.innerHTML = '<em>No domain summaries available.</em>';
        return;
    }
    
    // Extract domain summaries from each domain's summary field
    const domainSummaries = {};
    
    // First, try to get summaries from each domain's 'summary' field
    if (data.sections) {
        for (const section of data.sections) {
            for (const domain of section.domains || []) {
                const domainId = domain.domain_id;
                if (domainId && domain.summary && typeof domain.summary === 'object') {
                    // Extract the summary data we need
                    const summary = domain.summary;
                    domainSummaries[domainId] = {
                        domain_id: domainId,
                        classification: summary.classification || '',
                        evidence: summary.evidence || [],
                        recommendations: summary.recommendations || ''
                    };
                }
            }
        }
    }
    
    // Fallback to domain_summaries under summary if no domain summaries found
    if (Object.keys(domainSummaries).length === 0 && 
        data.summary && 
        data.summary.domain_summaries && 
        typeof data.summary.domain_summaries === 'object') {
        
        for (const [domainId, summaryText] of Object.entries(data.summary.domain_summaries)) {
            if (!domainSummaries[domainId]) {  // Don't override existing summaries
                domainSummaries[domainId] = {
                    domain_id: domainId,
                    classification: '',
                    evidence: [],
                    recommendations: ''
                };
            }
        }
    }
    
    // Create table for domain summaries
    const table = document.createElement('table');
    table.className = 'results-table';
    
    // Add table header
    const thead = document.createElement('thead');
    thead.innerHTML = `
        <tr>
            <th>Domain</th>
            <th>Result</th>
            <th>Evidence</th>
            <th>Recommendations</th>
        </tr>
    `;
    table.appendChild(thead);
    
    // Add table body
    const tbody = document.createElement('tbody');
    
    // Track sections to add section headers
    let currentSection = null;
    
    // Get checklist data for domain titles and section info
    const checklist = data.checklist || {};
    
    for (const domain of domains) {
        const domainId = domain.domain_id;
        
        // First try to get title from domain object itself
        let domainTitle = domain.title || '';
        let sectionId = null;
        let sectionName = null;
        
        // Try to get section info from checklist
        if (checklist && checklist.sections) {
            for (const section of checklist.sections) {
                sectionId = section.section_id;
                sectionName = section.name;
                
                for (const checklistDomain of section.domains || []) {
                    if (checklistDomain.domain_id === domainId) {
                        domainTitle = checklistDomain.title || domainTitle;
                        break;
                    }
                }
                if (domainTitle) break;
            }
        }
        
        // Add section header if we're in a new section
        if (sectionId && sectionName && sectionId !== currentSection) {
            currentSection = sectionId;
            const sectionRow = document.createElement('tr');
            const sectionCell = document.createElement('td');
            sectionCell.colSpan = 4;
            sectionCell.className = 'section-header';
            sectionCell.textContent = `${sectionId} ${sectionName}`;
            sectionRow.appendChild(sectionCell);
            tbody.appendChild(sectionRow);
        }
        
        // Get domain summary if available
        const domainSummary = domainSummaries[domainId] || {};
        
        // Get classification from domain summary or fallback to compliance
        let classification = String(domainSummary.classification || '').trim();
        
        // If no classification, try to derive from compliance
        if (!classification && domain.compliance) {
            const compliance = String(domain.compliance).trim().toLowerCase();
            if (compliance.includes('fully_met') || compliance.includes('fully met') || compliance === 'yes') {
                classification = 'Excellent';
            } else if (compliance.includes('partially_met') || compliance.includes('partially met') || compliance === 'partial') {
                classification = 'Satisfactory';
            } else if (compliance.includes('not_met') || compliance.includes('not met') || compliance === 'no') {
                classification = 'Poor';
            }
        }
        
        // Format classification with appropriate class
        let classificationClass = 'compliance-Unknown';
        if (classification) {
            if (classification.toLowerCase() === 'excellent') {
                classificationClass = 'compliance-Excellent';
            } else if (classification.toLowerCase() === 'satisfactory') {
                classificationClass = 'compliance-Satisfactory';
            } else if (classification.toLowerCase() === 'poor') {
                classificationClass = 'compliance-Poor';
            }
        }
        
        // Create row for this domain
        const row = document.createElement('tr');
        
        // Domain column
        const domainCell = document.createElement('td');
        domainCell.textContent = `${domainId} ${domainTitle}`;
        row.appendChild(domainCell);
        
        // Result column
        const resultCell = document.createElement('td');
        const resultSpan = document.createElement('span');
        resultSpan.className = `compliance-badge ${classificationClass}`;
        resultSpan.textContent = classification || 'Unknown';
        resultCell.appendChild(resultSpan);
        row.appendChild(resultCell);
        
        // Evidence column
        const evidenceCell = document.createElement('td');
        if (domainSummary.evidence && Array.isArray(domainSummary.evidence)) {
            const evidenceList = document.createElement('ul');
            for (const item of domainSummary.evidence) {
                const li = document.createElement('li');
                li.textContent = item;
                evidenceList.appendChild(li);
            }
            evidenceCell.appendChild(evidenceList);
        } else {
            evidenceCell.textContent = 'No evidence provided';
        }
        row.appendChild(evidenceCell);
        
        // Recommendations column
        const recommendationsCell = document.createElement('td');
        recommendationsCell.textContent = domainSummary.recommendations || 'No recommendations provided';
        row.appendChild(recommendationsCell);
        
        tbody.appendChild(row);
    }
    
    table.appendChild(tbody);
    container.appendChild(table);
}
function renderDomains(data, checklist) {
    const container = document.getElementById('domains');
    container.innerHTML = '';
    
    // Get domains from sections in the new enriched checklist structure
    let domains = [];
    if (data.sections) {
        for (const section of data.sections) {
            if (section.domains) {
                domains = domains.concat(section.domains);
            }
        }
    } else if (data.domains) {
        domains = data.domains;
    }
    
    if (!domains || domains.length === 0) {
        container.innerHTML = '<em>No checklist domains found.</em>';
        return;
    }
    
    // Track sections to add section headers
    let currentSection = null;
    
    for (const domain of domains) {
        const domainId = domain.domain_id;
        
        // First try to get title from domain object itself
        let domainTitle = domain.title || '';
        let sectionId = null;
        let sectionName = null;
        
        // Try to get section info from checklist
        if (checklist && checklist.sections) {
            for (const section of checklist.sections) {
                sectionId = section.section_id;
                sectionName = section.name;
                
                for (const checklistDomain of section.domains || []) {
                    if (checklistDomain.domain_id === domainId) {
                        domainTitle = checklistDomain.title || domainTitle;
                        break;
                    }
                }
                if (domainTitle) break;
            }
        }
        
        // Add section header if we're in a new section
        if (sectionId && sectionName && sectionId !== currentSection) {
            currentSection = sectionId;
            const sectionHeader = document.createElement('h3');
            sectionHeader.textContent = `${sectionId} ${sectionName}`;
            container.appendChild(sectionHeader);
        }
        
        // Get domain summary from the domain's summary field first, then fall back to analysis summary
        let domainSummary = domain.summary || {};
        if (!domainSummary && data.summary && data.summary.domain_summaries) {
            domainSummary = data.summary.domain_summaries[domainId] || {};
        }
        
        // Get classification from domain summary or fallback to compliance
        let classification = '';
        if (typeof domainSummary === 'object') {
            classification = domainSummary.classification || '';
        } else {
            // If domain_summary is not a dict (e.g., it's a string), use it directly as classification
            classification = domainSummary || '';
        }
        
        if (!classification && domain.compliance) {
            const compliance = String(domain.compliance).trim().toLowerCase();
            if (compliance.includes('fully_met') || compliance.includes('fully met') || compliance === 'yes') {
                classification = 'Excellent';
            } else if (compliance.includes('partially_met') || compliance.includes('partially met') || compliance === 'partial') {
                classification = 'Satisfactory';
            } else if (compliance.includes('not_met') || compliance.includes('not met') || compliance === 'no') {
                classification = 'Poor';
            }
        }
        
        // Format classification with appropriate class
        let classificationClass = 'compliance-Unknown';
        if (classification) {
            if (classification.toLowerCase() === 'excellent') {
                classificationClass = 'compliance-Excellent';
            } else if (classification.toLowerCase() === 'satisfactory') {
                classificationClass = 'compliance-Satisfactory';
            } else if (classification.toLowerCase() === 'poor') {
                classificationClass = 'compliance-Poor';
            }
        }
        
        // Create domain header
        const domainHeader = document.createElement('h4');
        domainHeader.className = 'domain-title';
        domainHeader.textContent = `${domainId} ${domainTitle}`;
        container.appendChild(domainHeader);
        
        // Add summary if available
        if (typeof domainSummary === 'object' && domainSummary.summary) {
            const summaryPara = document.createElement('p');
            summaryPara.textContent = domainSummary.summary;
            container.appendChild(summaryPara);
        }
        
        // Add result with classification
        const resultDiv = document.createElement('div');
        resultDiv.style.marginBottom = '1em';
        const resultSpan = document.createElement('span');
        resultSpan.className = `compliance-badge ${classificationClass}`;
        resultSpan.textContent = classification || 'Unknown';
            table.appendChild(tbody);
            container.appendChild(table);
        } else {
            const noItemsMsg = document.createElement('p');
            noItemsMsg.textContent = 'No items found for this domain.';
            container.appendChild(noItemsMsg);
        }
    }
}

// --- Render Overall Assessment --- //
function renderOverallAssessment(data) {
    const container = document.getElementById('overall-assessment');
    container.innerHTML = '';
    
    // Get overall assessment from summary if available
    const summary = data.summary || {};
    const overallScore = summary.overall_score || 0;
    const overallClassification = summary.overall_classification || '';
    
    // Create overall score display
    const scoreDiv = document.createElement('div');
    scoreDiv.className = 'overall-score';
    scoreDiv.innerHTML = `Overall Score: <span class="score-value">${overallScore}</span>`;
    container.appendChild(scoreDiv);
    
    // Create assessment scale
    const scaleDiv = document.createElement('div');
    scaleDiv.className = 'assessment-scale';
    
    // Poor assessment
    const poorDiv = document.createElement('div');
    poorDiv.className = 'assessment-item assessment-poor';
    poorDiv.textContent = 'Poor';
    if (overallClassification.toLowerCase() === 'poor') {
        poorDiv.classList.add('assessment-active');
    }
    scaleDiv.appendChild(poorDiv);
    
    // Satisfactory assessment
    const satisfactoryDiv = document.createElement('div');
    satisfactoryDiv.className = 'assessment-item assessment-satisfactory';
    satisfactoryDiv.textContent = 'Satisfactory';
    if (overallClassification.toLowerCase() === 'satisfactory') {
        satisfactoryDiv.classList.add('assessment-active');
    }
    scaleDiv.appendChild(satisfactoryDiv);
    
    // Excellent assessment
    const excellentDiv = document.createElement('div');
    excellentDiv.className = 'assessment-item assessment-excellent';
    excellentDiv.textContent = 'Excellent';
    if (overallClassification.toLowerCase() === 'excellent') {
        excellentDiv.classList.add('assessment-active');
    }
    scaleDiv.appendChild(excellentDiv);
    
    container.appendChild(scaleDiv);
}

// --- Render Checklist Info --- //
function renderChecklistInfo(data) {
    const container = document.getElementById('checklist-info');
    container.innerHTML = '';
    
    // Get checklist data
    const checklist = data.checklist || {};
    
    // Display checklist version if available
    if (checklist.version) {
        const versionElem = document.createElement('p');
        versionElem.className = 'metadata-item';
        versionElem.textContent = `Checklist Version: ${checklist.version}`;
        container.appendChild(versionElem);
    }
    
    // Display checklist name if available
    if (checklist.name) {
        const nameElem = document.createElement('p');
        nameElem.className = 'metadata-item';
        nameElem.textContent = `Checklist Name: ${checklist.name}`;
        container.appendChild(nameElem);
    }
    
    // Display checklist ID if available
    if (checklist.checklist_id) {
        const idElem = document.createElement('p');
        idElem.className = 'metadata-item';
        idElem.textContent = `Checklist ID: ${checklist.checklist_id}`;
        container.appendChild(idElem);
    }
}

// --- PDF Export Function --- //
function setupPdfExport(token) {
    const exportButton = document.getElementById('export-pdf');
    if (!exportButton) return;
    
    exportButton.addEventListener('click', async () => {
        try {
            exportButton.disabled = true;
            exportButton.textContent = 'Generating PDF...';
            
            // Use the PDF export endpoint with the access token
            const API_BASE = 'https://reproai-app.lemondune-e106e75a.westeurope.azurecontainerapps.io/api/dmp/enriched-checklists/access/';
            const pdfUrl = `${API_BASE}${encodeURIComponent(token)}/export-pdf`;
            // Open in new tab instead of iframe for production API
            window.open(pdfUrl, '_blank');
            
            // Reset button after a delay
            setTimeout(() => {
                exportButton.disabled = false;
                exportButton.innerHTML = '<span style="margin-right: 5px;">ðŸ“„</span> Download PDF Report';
            }, 2000);
        } catch (err) {
            console.error('Failed to export PDF:', err);
            exportButton.disabled = false;
            exportButton.innerHTML = '<span style="margin-right: 5px;">ðŸ“„</span> Download PDF Report';
            alert('Failed to generate PDF. Please try again.');
        }
    });
}

// --- Main Logic --- //
(async function() {
    const token = getTokenFromUrl();
    if (!token) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('error').textContent = 'No token provided in URL.';
        return;
    }
    try {
        // You may need to adjust the API_BASE depending on your deployment
        const API_BASE = 'https://reproai-app.lemondune-e106e75a.westeurope.azurecontainerapps.io/api/dmp/enriched-checklists/access/';
        const response = await fetch(`${API_BASE}${encodeURIComponent(token)}`);
        if (!response.ok) throw new Error('API returned ' + response.status);
        const data = await response.json();
        
        // Fetch base checklist data if needed for additional context
        let checklist = data.checklist || {};
        if (!checklist.sections && data.checklist_id) {
            try {
                const checklistResponse = await fetch(`https://reproai-app.lemondune-e106e75a.westeurope.azurecontainerapps.io/api/dmp/checklists/${data.checklist_id}`);
                if (checklistResponse.ok) {
                    checklist = await checklistResponse.json();
                }
            } catch (checklistErr) {
                console.warn('Failed to fetch base checklist:', checklistErr);
            }
        }
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('results').style.display = 'block';
        
        // Render all sections
        renderManuscriptMetadata(data);
        renderAnalysisInfo(data);
        renderOverallAssessment(data);
        renderChecklistInfo(data);
        renderFeedbackNote(data.summary && data.summary.feedback_note);
        renderDomainSummaries(data, checklist);
        renderDomains(data, checklist);
        
        // Setup PDF export functionality
        setupPdfExport(token);
        
    } catch (err) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('error').textContent = 'Failed to load analysis: ' + err;
    }
})();
</script>
</body>
</html>
